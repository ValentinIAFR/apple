<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>DJ Smart Playlist</title>

<style>

/* ===== BASE ===== */
body{
    margin:0;
    background:#0b0b0d;
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    color:#e6e6e6;
}

.app{
    max-width:1000px;
    margin:auto;
    padding:25px;
}

h1{
    font-size:28px;
    font-weight:600;
    color:#fff;
}

/* ===== INPUT ===== */
input{
    width:100%;
    padding:14px;
    border-radius:8px;
    border:1px solid #1f1f24;
    background:#141418;
    color:#aaa;
    margin:15px 0;
}

input:hover{
    border-color:#2f8cff;
}

/* bouton fichier */
input[type="file"]::file-selector-button{
    background:#0a1f44;
    color:white;
    border:none;
    padding:10px 16px;
    margin-right:15px;
    border-radius:6px;
    cursor:pointer;
}

/* ===== PROGRESS BAR ===== */
.progress-container{
    background:#111114;
    border:1px solid #1c1c20;
    border-radius:8px;
    overflow:hidden;
    height:18px;
    margin-top:10px;
}

.progress-bar{
    height:100%;
    width:0%;
    background:linear-gradient(90deg,#2f8cff,#00c6ff);
    transition:width 0.2s;
}

.progress-text{
    font-size:12px;
    color:#8a8a8f;
    margin-top:5px;
}

/* ===== LISTES ===== */
ul{
    list-style:none;
    padding:0;
}

li{
    background:#111114;
    border:1px solid #1c1c20;
    margin-bottom:8px;
    padding:14px;
    border-radius:6px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    transition:.15s;
    cursor:pointer;
}

li:hover{
    background:#17171c;
    border-color:#2f8cff;
}

.current{
    border:1px solid #2f8cff !important;
    background:#1a2230 !important;
    box-shadow:0 0 15px rgba(47,140,255,0.4);
}

/* ===== BOUTONS ===== */
.controls button{
    background:#0a1f44;
    color:white;
    border:none;
    padding:10px 16px;
    border-radius:6px;
    margin-right:10px;
    cursor:pointer;
}

/* ===== WAVEFORM ===== */
#waveform{
    width:100%;
    height:120px;
    background:#0f1116;
    border:1px solid #1c1c20;
    border-radius:8px;
    margin-top:15px;
}

/* ===== PLAYER ===== */
audio{
    width:100%;
    margin-top:10px;
}

h2{
    font-size:14px;
    color:#8a8a8f;
    text-transform:uppercase;
    margin-top:25px;
}

</style>
</head>

<body>
<div class="app">

<h1>DJ Smart Playlist</h1>

<input type="file" id="fileInput" multiple accept="audio/*">

<div class="progress-container">
    <div class="progress-bar" id="progressBar"></div>
</div>
<div class="progress-text" id="progressText">0%</div>

<input type="text" id="search" placeholder="Rechercher une track...">

<h2>Next Suggestions</h2>
<ul id="suggestions"></ul>

<h2>Tracks analysées</h2>
<ul id="trackList"></ul>

<h2>Preview Player</h2>
<canvas id="waveform"></canvas>
<audio id="player" controls></audio>

<div class="controls">
    <button onclick="undo()">Annuler</button>
    <button onclick="resetSet()">Reset Set</button>
</div>

</div>

<script>

/* =========================
   DATA
========================= */

let tracks=[];
let playedHistory=[];
let audioCtx=new (window.AudioContext||window.webkitAudioContext)();
let analyser, source;

/* =========================
   IMPORT + PROGRESS
========================= */

fileInput.onchange=async(e)=>{
    const files=[...e.target.files];
    let done=0;

    for(const file of files){

        const bpm=110+Math.random()*20; // placeholder analyse
        const key=Math.floor(Math.random()*12)+"A";

        tracks.push({
            name:file.name,
            bpm:Math.round(bpm),
            key:key,
            file:file
        });

        done++;
        let percent=Math.round(done/files.length*100);
        progressBar.style.width=percent+"%";
        progressText.textContent=percent+"%";
        await new Promise(r=>setTimeout(r,50));
    }

    renderTracks();
    updateSuggestions();
};

/* =========================
   RENDER TRACKS
========================= */

function renderTracks(filter=""){
    trackList.innerHTML="";

    tracks
    .filter(t=>t.name.toLowerCase().includes(filter.toLowerCase()))
    .forEach(track=>{
        const li=document.createElement("li");
        li.innerHTML=`<strong>${track.name}</strong>
        <span>${track.bpm} BPM • ${track.key}</span>`;

        li.onclick=()=>selectTrack(track);
        trackList.appendChild(li);
    });
}

/* =========================
   SEARCH
========================= */

search.oninput=e=>{
    renderTracks(e.target.value);
};

/* =========================
   SELECT TRACK
========================= */

function selectTrack(track){

    playedHistory.push(track);
    tracks=tracks.filter(t=>t!==track);

    playPreview(track.file);
    renderTracks();
    updateSuggestions();
}

/* =========================
   SUGGESTION ENGINE
========================= */

function updateSuggestions(){

    suggestions.innerHTML="";

    if(!playedHistory.length) return;

    const current=playedHistory[playedHistory.length-1];

    const scored=[...tracks].map(t=>{
        let score=0;
        score+=Math.abs(t.bpm-current.bpm);
        if(t.key===current.key) score-=5;
        return {track:t,score};
    });

    scored.sort((a,b)=>a.score-b.score);

    scored.slice(0,3).forEach(obj=>{
        const li=document.createElement("li");
        li.innerHTML=`<strong>${obj.track.name}</strong>
        <span>${obj.track.bpm} BPM • ${obj.track.key}</span>`;
        li.onclick=()=>selectTrack(obj.track);
        suggestions.appendChild(li);
    });
}

/* =========================
   PREVIEW PLAYER + WAVEFORM
========================= */

function playPreview(file){

    const url=URL.createObjectURL(file);
    player.src=url;

    const reader=new FileReader();
    reader.readAsArrayBuffer(file);

    reader.onload=async()=>{
        const buffer=await audioCtx.decodeAudioData(reader.result);

        if(source) source.disconnect();

        source=audioCtx.createBufferSource();
        analyser=audioCtx.createAnalyser();

        source.buffer=buffer;
        source.connect(analyser);
        analyser.connect(audioCtx.destination);

        drawWaveform();
    };
}

function drawWaveform(){

    const canvas=document.getElementById("waveform");
    const ctx=canvas.getContext("2d");

    analyser.fftSize=256;
    const data=new Uint8Array(analyser.frequencyBinCount);

    function draw(){
        requestAnimationFrame(draw);

        analyser.getByteFrequencyData(data);

        ctx.fillStyle="#0f1116";
        ctx.fillRect(0,0,canvas.width,canvas.height);

        let barWidth=(canvas.width/data.length)*2;

        for(let i=0;i<data.length;i++){
            let h=data[i]/2;
            ctx.fillStyle="#2f8cff";
            ctx.fillRect(i*barWidth,canvas.height-h,barWidth-1,h);
        }
    }
    draw();
}

/* =========================
   UNDO + RESET
========================= */

function undo(){
    if(!playedHistory.length) return;
    const last=playedHistory.pop();
    tracks.unshift(last);
    renderTracks();
    updateSuggestions();
}

function resetSet(){
    tracks=[...tracks,...playedHistory];
    playedHistory=[];
    suggestions.innerHTML="";
    renderTracks();
}

</script>
</body>
</html>
