<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DJ PRO VÎ›LEN7</title>
<link rel="stylesheet" href="style.css">
</head>

<body>

<div class="app">

<h1>DJ PRO VÎ›LEN7</h1>

<input type="file" id="fileInput" multiple accept=".mp3">

<div class="buttons">
<button id="undoBtn">â†© Annuler</button>
<button id="resetBtn">ðŸ”„ Reset Set</button>
</div>

<h2>Next Suggestions</h2>
<div id="suggestion"></div>

<h2>Tracks analysÃ©s</h2>

<div class="searchContainer">
<input type="text" id="searchBar"
placeholder="Rechercher une musique...">
</div>

<ul id="trackList"></ul>

<h2>Preview Deck</h2>
<div class="player">
<canvas id="waveform"></canvas>
<audio id="audioPlayer" controls></audio>
</div>

<h2>Historique du set</h2>
<ul id="history"></ul>

</div>

<script>
window.addEventListener("DOMContentLoaded",()=>{

const audioCtx=new (window.AudioContext||window.webkitAudioContext)();
const audio=document.getElementById("audioPlayer");
const canvas=document.getElementById("waveform");
const ctx=canvas.getContext("2d");

canvas.width=900;
canvas.height=120;

let library=JSON.parse(localStorage.getItem("dj_library"))||[];
let tracks=JSON.parse(localStorage.getItem("dj_tracks"))||[];
let history=JSON.parse(localStorage.getItem("dj_history"))||[];

let currentTrack=history.length?history.at(-1):null;
let searchText="";

function save(){
localStorage.setItem("dj_library",JSON.stringify(library));
localStorage.setItem("dj_tracks",JSON.stringify(tracks));
localStorage.setItem("dj_history",JSON.stringify(history));
}

/* ========= SEARCH ========= */

searchBar.oninput=e=>{
searchText=e.target.value.toLowerCase();
renderTracks();
};

/* ========= IMPORT ========= */

fileInput.addEventListener("change",async e=>{

for(const file of e.target.files){

if(library.find(t=>t.title===file.name)) continue;

const buffer=await audioCtx.decodeAudioData(
await file.arrayBuffer()
);

const track={
title:file.name,
file:file,
bpm:120+Math.floor(Math.random()*10),
energy:Math.floor(Math.random()*100),
key:["1A","2A","3A","4A","5A","6A","7A","8A","9A","10A","11A","12A"][Math.floor(Math.random()*12)]
};

library.push(track);
tracks.push(track);
}

save();
renderAll();
});

/* ========= PLAYER + WAVEFORM ========= */

async function previewTrack(track){

audio.src=URL.createObjectURL(track.file);
audio.play();

const arrayBuffer=await track.file.arrayBuffer();
const buffer=await audioCtx.decodeAudioData(arrayBuffer);

drawWaveform(buffer);
}

function drawWaveform(buffer){

const data=buffer.getChannelData(0);
const step=Math.floor(data.length/canvas.width);

ctx.clearRect(0,0,canvas.width,canvas.height);
ctx.beginPath();

for(let i=0;i<canvas.width;i++){
let min=1,max=-1;

for(let j=0;j<step;j++){
const datum=data[(i*step)+j];
if(datum<min)min=datum;
if(datum>max)max=datum;
}

ctx.moveTo(i,(1+min)*60);
ctx.lineTo(i,(1+max)*60);
}

ctx.strokeStyle="#2f8cff";
ctx.stroke();
}

/* ========= DJ LOGIC ========= */

function transitionScore(a,b){
return Math.abs(a.bpm-b.bpm)
+Math.abs(a.energy-b.energy)*0.6;
}

function playTrack(track){
currentTrack=track;
history.push(track);
tracks=tracks.filter(t=>t.title!==track.title);
save();
renderAll();
previewTrack(track);
}

/* ========= UNDO ========= */

undoBtn.onclick=()=>{
if(!history.length)return;

const last=history.pop();
tracks.push(last);
currentTrack=history.at(-1)||null;

save();
renderAll();
};

/* ========= RESET ========= */

resetBtn.onclick=()=>{
tracks=[...library];
history=[];
currentTrack=null;
save();
renderAll();
};

/* ========= RENDER ========= */

function renderTracks(){

trackList.innerHTML="";

tracks
.filter(t=>t.title.toLowerCase().includes(searchText))
.forEach(track=>{

const li=document.createElement("li");

li.innerHTML=`
<div>
<strong>${track.title}</strong>
<span>${track.bpm} BPM â€¢ ${track.key}</span>
</div>
<div class="energy">${track.energy}</div>
`;

li.onclick=()=>previewTrack(track);
li.ondblclick=()=>playTrack(track);

trackList.appendChild(li);
});
}

function renderHistory(){
historyEl.innerHTML="";
history.slice().reverse().forEach(t=>{
const li=document.createElement("li");
li.textContent=t.title;
history.appendChild(li);
});
}

/* ========= TOP 3 ========= */

function updateSuggestion(){

suggestion.innerHTML="";

if(!currentTrack){
suggestion.innerHTML="Choisis le premier morceau";
return;
}

[...tracks]
.sort((a,b)=>transitionScore(a,currentTrack)-transitionScore(b,currentTrack))
.slice(0,3)
.forEach(track=>{

const div=document.createElement("div");
div.className="suggestItem";

div.innerHTML=`
<strong>${track.title}</strong><br>
${track.bpm} BPM â€¢ ${track.key}
`;

div.onclick=()=>playTrack(track);

suggestion.appendChild(div);
});
}

function renderAll(){
renderTracks();
updateSuggestion();
}

renderAll();

});
</script>

</body>
</html>
