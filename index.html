<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DJ PRO VÎ›LEN7</title>
<link rel="stylesheet" href="style.css">
</head>

<body>

<div class="app">
    <h1>DJ PRO VÎ›LEN7</h1>

    <input type="file" id="fileInput" multiple accept=".mp3">

    <div class="buttons">
        <button id="undoBtn">â†© Annuler</button>
        <button id="resetBtn">ðŸ”„ Reset Set</button>
    </div>

    <h2>Tracks analysÃ©s</h2>
    <ul id="trackList"></ul>

    <h2>Next Suggestion</h2>
    <div id="suggestion">Choisis le premier morceau</div>

    <h2>Historique du set</h2>
    <ul id="history"></ul>
</div>

<script>
window.addEventListener("DOMContentLoaded", () => {

const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

let library = JSON.parse(localStorage.getItem("dj_library")) || [];
let tracks = JSON.parse(localStorage.getItem("dj_tracks")) || [];
let history = JSON.parse(localStorage.getItem("dj_history")) || [];
let currentTrack = null;

const camelotWheel =
["1A","2A","3A","4A","5A","6A","7A","8A","9A","10A","11A","12A"];


/* ========= SAVE ========= */

function save(){
 localStorage.setItem("dj_library",JSON.stringify(library));
 localStorage.setItem("dj_tracks",JSON.stringify(tracks));
 localStorage.setItem("dj_history",JSON.stringify(history));
}


/* ========= IMPORT ========= */

document.getElementById("fileInput")
.addEventListener("change", async e => {

 for(const file of e.target.files){

    if(library.find(t=>t.title===file.name)) continue;

    const arrayBuffer = await file.arrayBuffer();
    const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);

    const track={
        title:file.name,
        bpm:detectBPM(audioBuffer),
        energy:detectEnergy(audioBuffer),
        key:detectKey(audioBuffer)
    };

    library.push(track);
    tracks.push(track);
 }

 save();
 renderAll();
});


/* ========= ANALYSE ========= */

function detectBPM(buffer){
 const data=buffer.getChannelData(0);
 const sr=buffer.sampleRate;
 let peaks=[];

 for(let i=0;i<data.length;i+=1024)
   if(data[i]>0.9) peaks.push(i);

 let intervals={};

 peaks.forEach((p,i)=>{
  for(let j=1;j<10;j++){
    if(peaks[i+j]){
      let tempo=60/((peaks[i+j]-p)/sr);
      while(tempo<80) tempo*=2;
      while(tempo>160) tempo/=2;
      tempo=Math.round(tempo);
      intervals[tempo]=(intervals[tempo]||0)+1;
    }
  }
 });

 let best=Object.entries(intervals).sort((a,b)=>b[1]-a[1])[0];
 return best?parseInt(best[0]):120;
}

function detectEnergy(buffer){
 const data=buffer.getChannelData(0);
 let sum=0;
 for(let i=0;i<data.length;i+=500)
   sum+=Math.abs(data[i]);

 return Math.min(100,Math.round(sum/(data.length/500)*300));
}

function detectKey(buffer){
 const analyser=audioCtx.createAnalyser();
 analyser.fftSize=2048;

 const source=audioCtx.createBufferSource();
 source.buffer=buffer;
 source.connect(analyser);
 analyser.connect(audioCtx.destination);
 source.start();

 const freq=new Uint8Array(analyser.frequencyBinCount);
 analyser.getByteFrequencyData(freq);

 let max=0,index=0;
 freq.forEach((v,i)=>{ if(v>max){max=v;index=i;} });

 source.stop();
 return camelotWheel[index%12];
}


/* ========= DJ LOGIC ========= */

function camelotDistance(a,b){
 const n1=parseInt(a);
 const n2=parseInt(b);
 return Math.min(Math.abs(n1-n2),12-Math.abs(n1-n2));
}

function transitionScore(a,b){
 return Math.abs(a.bpm-b.bpm)
      + camelotDistance(a.key,b.key)*10
      + Math.abs(a.energy-b.energy)*0.6;
}


/* ========= PLAY TRACK ========= */

function playTrack(track){

 currentTrack=track;

 history.push(track);

 /* SUPPRIME DES TRACKS ANALYSÃ‰S */
 tracks = tracks.filter(t=>t.title!==track.title);

 save();
 renderAll();
}


/* ========= UNDO ========= */

document.getElementById("undoBtn").onclick=()=>{

 if(history.length===0) return;

 const last=history.pop();
 tracks.push(last);
 currentTrack=null;

 save();
 renderAll();
};


/* ========= RESET ========= */

document.getElementById("resetBtn").onclick=()=>{

 tracks=[...library];
 history=[];
 currentTrack=null;

 save();
 renderAll();

 document.getElementById("suggestion").innerHTML =
   "Choisis le premier morceau";
};


/* ========= RENDER ========= */

function renderTracks(){

 const list=document.getElementById("trackList");
 list.innerHTML="";

 tracks.forEach(track=>{

   const li=document.createElement("li");

   li.innerHTML=`
     <div>
       <strong>${track.title}</strong>
       <span>${track.bpm} BPM â€¢ ${track.key}</span>
     </div>
     <div class="energy">${track.energy}</div>
   `;

   li.onclick=()=>playTrack(track);

   list.appendChild(li);
 });
}

function renderHistory(){
 const h=document.getElementById("history");
 h.innerHTML="";
 history.slice().reverse().forEach(t=>{
   const li=document.createElement("li");
   li.textContent=t.title;
   h.appendChild(li);
 });
}

function updateSuggestion(){

 if(!currentTrack || tracks.length===0){
   document.getElementById("suggestion").innerHTML =
     "Choisis le premier morceau";
   return;
 }

 const sorted=[...tracks].sort((a,b)=>
   transitionScore(a,currentTrack) -
   transitionScore(b,currentTrack)
 );

 const best=sorted[0];

 document.getElementById("suggestion").innerHTML=
 `<strong>${best.title}</strong><br>
 ${best.bpm} BPM â€¢ ${best.key}<br>
 Energy ${best.energy}`;
}

function renderAll(){
 renderTracks();
 renderHistory();
 updateSuggestion();
}

renderAll();

});
</script>

</body>
</html>
