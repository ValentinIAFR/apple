<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DJ Flow Assistant</title>
<link rel="stylesheet" href="style.css">
</head>

<body>

<div class="app">

<h1>DJ Flow Assistant</h1>

<input type="file" id="fileInput" multiple accept=".mp3">

<h2>Morceaux importés</h2>
<ul id="trackList"></ul>

<h2>Suggestion suivante</h2>
<div id="suggestion">Importe des morceaux...</div>

</div>

<script>

const tracks = [];

const camelotMap = {
 "C":"8B","Am":"8A",
 "G":"9B","Em":"9A",
 "D":"10B","Bm":"10A",
 "A":"11B","F#m":"11A",
 "E":"12B","C#m":"12A",
 "B":"1B","G#m":"1A",
 "F#":"2B","D#m":"2A",
 "Db":"3B","Bbm":"3A",
 "Ab":"4B","Fm":"4A",
 "Eb":"5B","Cm":"5A",
 "Bb":"6B","Gm":"6A",
 "F":"7B","Dm":"7A"
};

function normalizeBPM(bpm){
    if(bpm < 70) bpm *= 2;
    else if(bpm < 95) bpm *= 1.5;
    else if(bpm > 155) bpm /= 2;
    return Math.round(bpm);
}

function normalizeKey(key){
    const corrections = {
        "G":"Em",
        "C":"Am",
        "D":"Bm",
        "F":"Dm"
    };
    return corrections[key] || key;
}

document.getElementById("fileInput")
.addEventListener("change", async e => {

    for(const file of e.target.files){

        const audio = new Audio(URL.createObjectURL(file));
        await audio.play().catch(()=>{});
        audio.pause();

        // BPM simulé (analyse web limitée)
        let bpm = 80 + Math.random()*60;
        bpm = normalizeBPM(bpm);

        const possibleKeys = ["Am","Em","Dm","F#m","G","C","Bm"];
        let key = possibleKeys[Math.floor(Math.random()*possibleKeys.length)];
        key = normalizeKey(key);

        tracks.push({
            title:file.name,
            bpm,
            key,
            camelot: camelotMap[key] || "?"
        });
    }

    renderTracks();
    suggestNext();
});

function renderTracks(){

    const list = document.getElementById("trackList");
    list.innerHTML = "";

    tracks.forEach(t=>{
        const li = document.createElement("li");
        li.innerHTML =
            `<strong>${t.title}</strong>
             <span>${t.bpm} BPM • ${t.key} • ${t.camelot}</span>`;
        list.appendChild(li);
    });
}

function camelotDistance(a,b){
    if(!a || !b) return 99;
    const n1 = parseInt(a);
    const n2 = parseInt(b);
    return Math.min(Math.abs(n1-n2),12-Math.abs(n1-n2));
}

function suggestNext(){

    if(tracks.length < 2) return;

    const current = tracks[tracks.length-1];

    let best = null;
    let bestScore = 999;

    tracks.slice(0,-1).forEach(t=>{

        const bpmDiff = Math.abs(t.bpm-current.bpm);
        const keyDiff = camelotDistance(t.camelot,current.camelot);

        const score = bpmDiff + keyDiff*10;

        if(score < bestScore){
            bestScore = score;
            best = t;
        }
    });

    document.getElementById("suggestion").innerHTML =
        `<strong>${best.title}</strong><br>
         ${best.bpm} BPM • ${best.key} • ${best.camelot}`;
}

</script>
</body>
</html>
