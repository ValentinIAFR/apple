<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DJ PRO VΛLEN7</title>
<link rel="stylesheet" href="style.css">
</head>

<body>

<div class="app">
    <h1>DJ PRO VΛLEN7</h1>

    <input type="file" id="fileInput" multiple accept=".mp3">

    <h2>Tracks analysés</h2>
    <ul id="trackList"></ul>

    <h2>Next Suggestion</h2>
    <div id="suggestion">Aucun morceau sélectionné</div>

    <h2>Historique du set</h2>
    <ul id="history"></ul>
</div>

<script>
window.addEventListener("DOMContentLoaded", () => {

const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

let tracks = JSON.parse(localStorage.getItem("dj_tracks")) || [];
let history = JSON.parse(localStorage.getItem("dj_history")) || [];
let currentTrack = null;

const camelotWheel =
["1A","2A","3A","4A","5A","6A","7A","8A","9A","10A","11A","12A"];


/* ================= SAVE SYSTEM ================= */

function saveData(){
    localStorage.setItem("dj_tracks", JSON.stringify(tracks));
    localStorage.setItem("dj_history", JSON.stringify(history));
    localStorage.setItem("dj_current",
        currentTrack ? currentTrack.title : ""
    );
}


/* ================= IMPORT ================= */

document.getElementById("fileInput")
.addEventListener("change", async e => {

 for(const file of e.target.files){

    if(tracks.find(t=>t.title===file.name)) continue;

    const arrayBuffer = await file.arrayBuffer();
    const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);

    const bpm = detectBPM(audioBuffer);
    const energy = detectEnergy(audioBuffer);
    const key = detectKey(audioBuffer);

    tracks.push({
        title:file.name,
        bpm,
        energy,
        key
    });
 }

 autoEnergySort();
 saveData();
 renderTracks();
});


/* ================= BPM ================= */

function detectBPM(buffer){

 const data = buffer.getChannelData(0);
 const sampleRate = buffer.sampleRate;

 let peaks=[];

 for(let i=0;i<data.length;i+=1024){
    if(data[i]>0.9) peaks.push(i);
 }

 let intervals={};

 peaks.forEach((peak,i)=>{
   for(let j=1;j<10;j++){
     if(peaks[i+j]){
        let interval=peaks[i+j]-peak;
        let tempo=60/(interval/sampleRate);

        while(tempo<80) tempo*=2;
        while(tempo>160) tempo/=2;

        tempo=Math.round(tempo);
        intervals[tempo]=(intervals[tempo]||0)+1;
     }
   }
 });

 let best=Object.entries(intervals)
      .sort((a,b)=>b[1]-a[1])[0];

 return best?parseInt(best[0]):120;
}


/* ================= ENERGY ================= */

function detectEnergy(buffer){
 const data=buffer.getChannelData(0);
 let sum=0;

 for(let i=0;i<data.length;i+=500){
    sum+=Math.abs(data[i]);
 }

 let energy=(sum/(data.length/500))*100;
 return Math.min(100,Math.round(energy*3));
}


/* ================= KEY ================= */

function detectKey(buffer){

 const analyser=audioCtx.createAnalyser();
 analyser.fftSize=2048;

 const source=audioCtx.createBufferSource();
 source.buffer=buffer;
 source.connect(analyser);
 analyser.connect(audioCtx.destination);

 source.start(0);

 const freqData=new Uint8Array(analyser.frequencyBinCount);
 analyser.getByteFrequencyData(freqData);

 let max=0,index=0;

 freqData.forEach((v,i)=>{
   if(v>max){max=v;index=i;}
 });

 source.stop();

 return camelotWheel[index%12];
}


/* ================= DJ LOGIC ================= */

function camelotDistance(a,b){
 const n1=parseInt(a);
 const n2=parseInt(b);
 return Math.min(Math.abs(n1-n2),12-Math.abs(n1-n2));
}

function transitionScore(track,target){

 const bpmDiff=Math.abs(track.bpm-target.bpm);
 const keyDiff=camelotDistance(track.key,target.key);
 const energyDiff=Math.abs(track.energy-target.energy);

 return bpmDiff + keyDiff*10 + energyDiff*0.6;
}


/* ================= AUTO ENERGY ORDER ================= */

function autoEnergySort(){
   tracks.sort((a,b)=>a.energy-b.energy);
}


/* ================= RENDER ================= */

function renderTracks(){

 const list=document.getElementById("trackList");
 list.innerHTML="";

 let displayTracks=[...tracks];

 if(currentTrack){
   displayTracks.sort((a,b)=>
     transitionScore(a,currentTrack) -
     transitionScore(b,currentTrack)
   );
 }

 displayTracks.forEach(track=>{

   const li=document.createElement("li");

   if(currentTrack && track.title===currentTrack.title)
      li.classList.add("current");

   li.innerHTML=`
     <div>
       <strong>${track.title}</strong>
       <span>${track.bpm} BPM • ${track.key}</span>
     </div>
     <div class="energy">${track.energy}</div>
   `;

   li.onclick=()=>{
      currentTrack=track;
      history.push(track.title);

      saveData();
      renderTracks();
      renderHistory();
      updateSuggestion();
   };

   list.appendChild(li);
 });
}


/* ================= HISTORY ================= */

function renderHistory(){
 const h=document.getElementById("history");
 h.innerHTML="";
 history.slice(-10).reverse().forEach(t=>{
    const li=document.createElement("li");
    li.textContent=t;
    h.appendChild(li);
 });
}


/* ================= SUGGESTION ================= */

function updateSuggestion(){

 if(!currentTrack) return;

 const others=tracks.filter(t=>t.title!==currentTrack.title);

 others.sort((a,b)=>
   transitionScore(a,currentTrack) -
   transitionScore(b,currentTrack)
 );

 const best=others[0];

 document.getElementById("suggestion").innerHTML=
 `<strong>${best.title}</strong><br>
 ${best.bpm} BPM • ${best.key}<br>
 Energy ${best.energy}`;
}


/* ================= RESTORE SESSION ================= */

const savedCurrent = localStorage.getItem("dj_current");

if(savedCurrent){
   currentTrack = tracks.find(t=>t.title===savedCurrent);
}

renderTracks();
renderHistory();
updateSuggestion();

});
</script>

</body>
</html>
